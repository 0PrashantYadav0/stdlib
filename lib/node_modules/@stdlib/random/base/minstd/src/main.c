/**
* @license Apache-2.0
*
* Copyright (c) 2018 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

#include <stdlib.h>
#include <stdint.h>
#include "stdlib/random/base/minstd.h"

// Define the LCG multiplier:
static const int32_t A = 16807;

// Define the maximum signed 32-bit integer: 2147483647 => 0x7fffffff => 01111111111111111111111111111111
static const int32_t MAX_INT32 = 0x7fffffff;

// Define the normalization constant:
static const double NORMALIZATION_CONSTANT = 2147483646.0; // MAX_INT32 - 1

/**
* Returns a pseudorandom integer.
*
* @private
* @param prng  MINSTD PRNG
* @return      pseudorandom integer
*/
static inline int32_t next( struct stdlib_base_minstd_prng *prng ) {
	int32_t state = prng->state;

	// Explicitly cast to 64-bit to handle integer overflow:
	state = (A*(int64_t)state) % MAX_INT32;

	// Update the PRNG state:
	prng->state = state;

	// Return the generated value:
	return state;
}

/**
* Returns a pseudorandom double-precision floating-point number on the interval `[0,1)`.
*
* @private
* @param prng  MINSTD PRNG
* @return      pseudorandom number
*/
static inline double normalized( struct stdlib_base_minstd_prng *prng ) {
	double state = (double)next( prng );
	return (state-1.0) / NORMALIZATION_CONSTANT;
}

/**
* Returns a pointer to a dynamically allocated MINSTD PRNG.
*
* ## Notes
*
* -   The user is responsible for freeing the allocated memory.
*
* @param seed  PRNG seed
* @return      pointer to a dynamically allocated PRNG or, if unable to allocate memory, a null pointer
*
* @example
* #include <stdlib.h>
* #include <stdio.h>
* #include <stdint.h>
* #include "stdlib/random/base/minstd.h"
*
* // Create a MINSTD PRNG:
* struct stdlib_base_minstd_prng *prng = stdlib_base_minstd_prng_allocate( 12345 );
* if ( prng == NULL ) {
*     fprintf( stderr, "Error allocating memory.\n" );
*     exit( 1 );
* }
*
* int32_t r = prng->next();
*
* // ...
*
* r = prng->next();
* r = prng->next();
*
* // ...
*
* // Free allocated memory:
* stdlib_base_minstd_prng_free( prng );
*/
struct stdlib_base_minstd_prng * stdlib_base_minstd_prng_allocate( const int32_t seed ) {
	// Initialize the PRNG state:
	int32_t state = seed;

	// Create the PRNG:
	struct stdlib_base_minstd_prng prng = {
		"minstd",                               // name
		1,                                      // min
		MAX_INT32-1,                            // max: (2^{31}-1) - 1
		0.0,                                    // min (normalized)
		(MAX_INT32-2) / NORMALIZATION_CONSTANT, // max (normalized): (MIN-1)/MAX
		seed,                                   // seed
		state,                                  // state
		&next,                                  // next()
		&normalized                             // normalized()
	};
	return &prng;
}

/**
* Frees a MINSTD PRNG's allocated memory.
*
* @param prng  MINSTD PRNG
*
* @example
* #include <stdlib.h>
* #include <stdio.h>
* #include <stdint.h>
* #include "stdlib/random/base/minstd.h"
*
* // Create a MINSTD PRNG:
* struct stdlib_base_minstd_prng *prng = stdlib_base_minstd_prng_allocate( 12345 );
* if ( prng == NULL ) {
*     fprintf( stderr, "Error allocating memory.\n" );
*     exit( 1 );
* }
*
* int32_t r = prng->next();
*
* // ...
*
* r = prng->next();
* r = prng->next();
*
* // ...
*
* // Free allocated memory:
* stdlib_base_minstd_prng_free( prng );
*/
void stdlib_base_minstd_prng_free( struct stdlib_base_minstd_prng *prng ) {
	free( prng );
}
