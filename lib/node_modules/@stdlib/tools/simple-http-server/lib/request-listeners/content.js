'use strict';

// MODULES //

var debug = require( 'debug' )( 'simple-http-server:request-listener:content' );


// REQUEST LISTENER //

/**
* Returns a request listener for serving provided content.
*
* @private
* @param {Buffer} html - HTML content
* @param {Buffer} [javascript] - JavaScript content
* @returns {Function} request listener
*/
function requestListener( html, javascript ) {
	/**
	* Callback invoked upon receiving an HTTP request for provided content.
	*
	* @private
	* @param {Object} request - HTTP request object
	* @param {Object} response - HTTP response object
	*/
	return function requestListener( request, response ) {
		debug( 'Received a request for %s', request.url );

		if ( !javascript ) {
			response.once( 'finish', exit );
		} else if ( request.url === '/bundle.js' ) {
			response.once( 'finish', exit );
			return sendJavaScript( request, response );
		}
		sendHTML( request, response );
	}; // end FUNCTION requestListener()

	/**
	* Sends HTML content in response to a client request.
	*
	* @private
	* @param {Object} request - HTTP request object
	* @param {Object} response - HTTP response object
	*/
	function sendHTML( request, response ) {
		debug( 'Sending HTML...' );
		response.statusCode = 200;
		response.setHeader( 'Content-Type', 'text/html' );
		response.setHeader( 'Content-Length', html.length );
		response.end( html );
	} // end FUNCTION sendHTML()

	/**
	* Sends JavaScript content in response to a client request.
	*
	* @private
	* @param {Object} request - HTTP request object
	* @param {Object} response - HTTP response object
	*/
	function sendJavaScript( request, response ) {
		debug( 'Sending JavaScript...' );
		response.statusCode = 200;
		response.setHeader( 'Content-Type', 'text/javascript' );
		response.setHeader( 'Content-Length', javascript.length );
		response.end( javascript );
	} // end FUNCTION sendJavaScript()

	/**
	* Callback invoked once the process should exit.
	*
	* @private
	*/
	function exit() {
		debug( 'Finishing serving content.' );
		debug( 'Exiting...' );
		process.exit( 0 );
	} // end FUNCTION exit()
} // end FUNCTION requestListener()


// EXPORTS //

module.exports = requestListener;
