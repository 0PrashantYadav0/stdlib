
# VARIABLES #

ifndef VERBOSE
	QUIET := @
endif

# Determine the absolute path of the Makefile (see http://blog.jgc.org/2007/01/what-makefile-am-i-in.html):
this_dir := $(dir $(CURDIR)/$(word $(words $(MAKEFILE_LIST)),$(MAKEFILE_LIST)))

# Remove the trailing slash:
this_dir := $(patsubst %/,%,$(this_dir))

# Define the root package directory:
root_dir := $(this_dir)/..

# Define the directory containing source files:
src_dir := $(root_dir)/src

# Define the directory containing example files:
examples_dir := $(root_dir)/examples

# Define the command for [node-gyp][1].
#
# [1]: https://github.com/nodejs/node-gyp

NODE_GYP ?= node-gyp

# Define the C compiler:
C_COMPILER ?= gcc

# Define the Fortran compiler:
FORTRAN_COMPILER ?= gfortran

# Define the Fortran/C linker:
LINKER ?= gfortran


# TARGETS #

# Default target.
#
# This target is the default target.

all:
	$(QUIET) cd $(src_dir) && \
		C_COMPILER=$(C_COMPILER) \
		FORTRAN_COMPILER=$(FORTRAN_COMPILER) \
		LINKER=$(LINKER) \
		$(MAKE) all

.PHONY: all


# Build add-on.
#
# This target builds the native add-on.

addon:
	$(QUIET) $(NODE_GYP) --directory $(root_dir) rebuild

.PHONY: addon


# Run examples.
#
# This target compiles and runs example files.

examples:
	$(QUIET) cd $(examples_dir) && \
		C_COMPILER=$(C_COMPILER) \
		LINKER=$(LINKER) \
		$(MAKE) all && \
		$(MAKE) run

.PHONY: examples


# List libraries.
#
# This target lists compiled libraries.

list:
	$(QUIET) cd $(src_dir) && \
		C_COMPILER=$(C_COMPILER) \
		FORTRAN_COMPILER=$(FORTRAN_COMPILER) \
		LINKER=$(LINKER) \
		$(MAKE) list

.PHONY: list


# Perform clean-up.
#
# This target removes all generated files.

clean: clean-libs clean-examples clean-addon

.PHONY: clean


# Clean libraries.
#
# This target removes generated library files.

clean-libs:
	$(QUIET) cd $(src_dir) && $(MAKE) clean

.PHONY: clean-libs


# Clean examples.
#
# This target removes generated examples.

clean-examples:
	$(QUIET) cd $(examples_dir) && $(MAKE) clean

.PHONY: clean-examples


# Clean add-on.
#
# This target removes generated native add-ons files.

clean-addon:
	$(QUIET) $(NODE_GYP) --directory $(root_dir) clean

.PHONY: clean-addon
