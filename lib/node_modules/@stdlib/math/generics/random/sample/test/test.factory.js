'use strict';

// MODULES //

var tape = require( 'tape' );
var isNumberArray = require( '@stdlib/utils/is-number' ).isNumberArray;
var isStringArray = require( '@stdlib/utils/is-string' ).isStringArray;
var factory = require( './../lib/factory.js' );


// TESTS //

tape( 'main export is a function', function test( t ) {
	t.ok( true, __filename );
	t.equal( typeof factory, 'function', 'main export is a function' );
	t.end();
});

tape( 'the function throws an error if provided an argument which is neither array-like or an options object', function test( t ) {
	var values;
	var i;

	values = [
		5,
		NaN,
		null,
		undefined,
		true,
		function(){}
	];
	for ( i = 0; i < values.length; i++ ) {
		t.throws( badValue( values[i] ), TypeError, 'throws a type error when provided '+values[i] );
	}
	t.end();

	function badValue( value ) {
		return function badValue() {
			factory( value );
		};
	}
});

tape( 'the function throws an error if provided a `pool` argument which is not array-like', function test( t ) {
	var values;
	var i;

	values = [
		5,
		NaN,
		null,
		undefined,
		true,
		function(){},
		{}
	];
	for ( i = 0; i < values.length; i++ ) {
		t.throws( badValue( values[i] ), TypeError, 'throws a type error when provided '+values[i] );
	}
	t.end();

	function badValue( value ) {
		return function badValue() {
			factory( value, {
				'seed': 323
			});
		};
	}
});

tape( 'the function allows setting a default `replace` strategy for the returned function', function test( t ) {
	var expected;
	var sample;
	var actual;

	// When not supplying `pool`...
	sample = factory({
		'replace': false,
		'seed': 223
	});

	expected = [ 2, 5, 6, 1, 3, 4 ];
	actual = sample( [ 1, 2, 3, 4, 5, 6 ] );
	t.equal( actual.length, 6, 'returned array has six elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	expected = [ 4, 3, 1, 2, 1, 3 ];
	actual = sample( [ 1, 2, 3, 4, 5, 6 ], {
		'replace': true
	});
	t.equal( actual.length, 6, 'returned array has six elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	// When supplying `pool`...
	sample = factory( [ 1, 2, 3, 4, 5, 6 ], {
		'replace': false,
		'seed': 223
	});

	expected = [ 5, 5, 1, 1, 5, 4 ];
	actual = sample({
		'replace': true
	});
	t.equal( actual.length, 6, 'returned array has six elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	expected = [ 2, 6, 4 ];
	actual = sample({
		'size': 3
	});
	t.equal( actual.length, 3, 'returned array has three elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	expected = [ 4, 2, 5 ];
	actual = sample({
		'size': 3
	});
	t.equal( actual.length, 3, 'returned array has three elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});

tape( 'the function allows setting a default `mutate` strategy for the returned function', function test( t ) {
	var expected;
	var sample;
	var actual;

	sample = factory( [ 1, 2, 3, 4, 5, 6 ], {
		'replace': false,
		'mutate': true,
		'seed': 223
	});

	expected = [ 2, 5, 6 ];
	actual = sample({
		'size': 3
	});
	t.equal( actual.length, 3, 'returned array has three elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	// Strategy can be overriden...
	expected = [ 4, 1, 3 ];
	actual = sample({
		'size': 3,
		'mutate': false
	});
	t.equal( actual.length, 3, 'returned array has three elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	expected = [ 1, 3, 4 ];
	actual = sample({
		'size': 3
	});
	t.equal( actual.length, 3, 'returned array has three elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});

tape( 'the function allows setting a default `size` strategy for the returned function', function test( t ) {
	var expected;
	var sample;
	var actual;

	sample = factory({
		'size': 5,
		'seed': 223
	});

	expected = [ 1, 1, 0, 0, 1 ];
	actual = sample( [ 0, 1 ] );
	t.equal( actual.length, 5, 'returned array has five elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	sample = factory( [ 0, 1 ], {
		'size': 5,
		'seed': 223
	});

	expected = [ 1, 1, 0, 0, 1 ];
	actual = sample();
	t.equal( actual.length, 5, 'returned array has five elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});

tape( 'the function fixes the population to sample from when supplied an array-like object', function test( t ) {
	var expected;
	var sample;
	var actual;
	var bool;
	var len;
	var i;
	var x;

	x = [ 0, 1 ];
	expected = [ 1, 0 ];
	len = x.length;
	sample = factory( x, {
		'seed': 329
	});
	actual = sample();
	t.equal( actual.length, len, 'returned array has two elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	x = 'abcdef';
	expected = [ 'd', 'c', 'f' ];
	len = x.length;
	sample = factory( x, {
		'seed': 329
	});
	actual = sample({
		'size': 3
	});
	t.equal( actual.length, 3, 'returned array has three elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	x = [ 0, 1 ];
	len = x.length;
	sample = factory( x );
	actual = sample();
	t.equal( actual.length, len, 'returned array has two elements' );
	for ( i = 0; i < len; i++ ) {
		bool = ( actual[i] === 0 || actual[i] === 1 );
		t.equal( bool, true, 'element is zero or one' );
	}

	x = 'abcdef';
	sample = factory( x );
	actual = sample({
		'size': 3
	});
	t.equal( actual.length, 3, 'returned array has three elements' );
	for ( i = 0; i < 3; i++ ) {
		bool = (
			actual[i] === 'a' ||
			actual[i] === 'b' ||
			actual[i] === 'c' ||
			actual[i] === 'd' ||
			actual[i] === 'e' ||
			actual[i] === 'f'
		);
		t.equal( bool, true, 'element is a, b, c, d, e, or f' );
	}

	t.end();
});

tape( 'when the population is fixed, the returned function returns `null` after all observations have been drawn when sampling without replacement and `mutate` is set to true', function test( t ) {
	var expected;
	var sample;
	var actual;
	var len;
	var x;

	expected = [ 5, 6, 1, 3, 2, 4 ];
	x = [ 1, 2, 3, 4, 5, 6 ];
	len = x.length;
	sample = factory( x, {
		'seed': 329,
		'mutate': true,
		'replace': false
	});

	actual = sample();
	t.equal( actual.length, len, 'returned array has six elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	actual = sample();
	t.equal( actual, null, 'returns null' );

	t.end();
});


tape( 'the returned function throws an error if not provided an array-like object', function test( t ) {
	var sample;
	var values;
	var i;

	sample = factory();

	values = [
		5,
		NaN,
		null,
		undefined,
		true,
		{},
		function(){}
	];
	for ( i = 0; i < values.length; i++ ) {
		t.throws( badValue( values[i] ), TypeError, 'throws a type error when provided '+values[i] );
	}
	t.end();

	function badValue( value ) {
		return function badValue() {
			sample( value );
		};
	}
});

tape( 'when fixing the population to sample from, the returned function throws an error if provided an options object which is not an object', function test( t ) {
	var sample;
	var values;
	var i;

	sample = factory( [ 0, 1 ] );

	values = [
		'5',
		5,
		NaN,
		null,
		undefined,
		true,
		[],
		function(){}
	];
	for ( i = 0; i < values.length; i++ ) {
		t.throws( badValue( values[i] ), TypeError, 'throws a type error when provided '+values[i] );
	}
	t.end();

	function badValue( value ) {
		return function badValue() {
			sample( value );
		};
	}
});

tape( 'the returned function throws an error if provided an options object which is not an object', function test( t ) {
	var sample;
	var values;
	var i;

	sample = factory();

	values = [
		'5',
		5,
		NaN,
		null,
		undefined,
		true,
		[],
		function(){}
	];
	for ( i = 0; i < values.length; i++ ) {
		t.throws( badValue( values[i] ), TypeError, 'throws a type error when provided '+values[i] );
	}
	t.end();

	function badValue( value ) {
		return function badValue() {
			sample( [], value );
		};
	}
});

tape( 'the returned function throws an error if provided an invalid option', function test( t ) {
	var sample;
	var values;
	var i;

	sample = factory();

	values = [
		'5',
		5,
		NaN,
		null,
		undefined,
		[],
		{},
		function(){}
	];
	for ( i = 0; i < values.length; i++ ) {
		t.throws( badValue( values[i] ), TypeError, 'throws a type error when provided '+values[i] );
	}
	t.end();

	function badValue( value ) {
		return function badValue() {
			sample( [], {
				'replace': value
			});
		};
	}
});

tape( 'the returned function throws an error if the `size` option exceeds the `pool` length when sampling without recplacement', function test( t ) {
	var sample;
	var values;
	var i;

	values = [
		[ [ 1, 2, 3 ], 4 ],
		[ [ 1, 2, 3, 4, 5, 6 ], 10 ]
	];
	for ( i = 0; i < values.length; i++ ) {
		t.throws( badValue( values[i] ), RangeError, 'throws a type error' );
	}
	t.end();

	function badValue( value ) {
		return function badValue() {
			sample = factory( value[ 0 ] );
			sample({
				'size': value[ 1 ],
				'replace': false
			});
		};
	}
});

tape( 'the returned function throws an error if provided a `size` option exceeding the input array length when sampling without recplacement', function test( t ) {
	var sample;
	var values;
	var i;

	sample = factory();

	values = [
		[ [ 1, 2, 3 ], 4 ],
		[ [ 1, 2, 3, 4, 5, 6 ], 10 ]
	];
	for ( i = 0; i < values.length; i++ ) {
		t.throws( badValue( values[i] ), RangeError, 'throws a type error' );
	}
	t.end();

	function badValue( value ) {
		return function badValue() {
			sample( value[ 0 ], {
				'size': value[ 1 ],
				'replace': false
			});
		};
	}
});

tape( 'attached to the returned function is the generator seed', function test( t ) {
	var sample = factory({
		'seed': 311
	});
	t.equal( typeof sample.SEED, 'number', 'has `SEED` property' );
	t.end();
});

tape( 'attached to the returned function is the underlying PRNG', function test( t ) {
	var sample = factory();
	t.equal( typeof sample.PRNG, 'function', 'has `PRNG` property' );
	t.end();
});

tape( 'the returned function samples characters with replacement from a string', function test( t ) {
	var expected;
	var actual;
	var sample;

	sample = factory({
		'seed': 311
	});

	expected = [ 'f', 'e', 'e', 'e', 'b', 'a' ];
	actual = sample( 'abcdef' );

	t.equal( isStringArray( actual ), true, 'returns an array of chracters' );
	t.equal( actual.length, 6, 'returned array has six elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});

tape( 'the returned function samples with replacement from an array', function test( t ) {
	var expected;
	var actual;
	var sample;

	sample = factory({
		'seed': 311
	});

	// Simple array:
	expected = [ 4, 4, 3, 3 ];
	actual = sample( [ 1, 2, 3, 4 ] );

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 4, 'returned array has four elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	// Typed array:
	expected = [ 6, 5, 8, 8, 8 ];
	actual = sample( new Float64Array( [ 5, 6, 7, 8, 9 ] ) );

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 5, 'returned array has five elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});

tape( 'the returned function samples without replacement from an array', function test( t ) {
	var expected;
	var actual;
	var sample;

	sample = factory({
		'seed': 789
	});

	// Simple array:
	expected = [ 4, 3, 1, 2 ];
	actual = sample( [ 1, 2, 3, 4 ], {
		'replace': false
	});

	// Typed array:
	expected = [ 7, 9, 6, 5, 8 ];
	actual = sample( new Int32Array( [ 5, 6, 7, 8, 9 ] ), {
		'replace': false
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 5, 'returned array has five elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});

tape( 'the returned function draws a sample with the specified size from an array (with replacement)', function test( t ) {
	var expected;
	var actual;
	var sample;

	sample = factory({
		'seed': 789
	});

	// Simple array:
	expected = [ 0, 0, 0, 1, 0, 1, 1, 1, 1, 1 ];
	actual = sample( [ 0, 1 ], {
		'size': 10
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 10, 'returned array has ten elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	// Typed array:
	expected = [ 1, 1, 1, 0, 0, 1, 0, 1, 1, 0 ];
	actual = sample( new Int8Array( [ 0, 1 ] ), {
		'size': 10
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 10, 'returned array has ten elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});

tape( 'the returned function draws a sample with the specified size from an array (without replacement)', function test( t ) {
	var expected;
	var actual;
	var sample;

	sample = factory({
		'seed': 656
	});

	// Simple array:
	expected = [ 3, 8, 7, 5 ];
	actual = sample( [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ], {
		'size': 4,
		'replace': false
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 4, 'returned array has four elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	// Typed array:
	expected = [ 3, 5, 4, 8, 6 ];
	actual = sample( new Int16Array( [ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ] ), {
		'size': 5,
		'replace': false
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 5, 'returned array has five elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});

tape( 'the returned function draws a sample from an array using specified probabilities (with replacement)', function test( t ) {
	var expected;
	var actual;
	var sample;

	sample = factory({
		'seed': 321
	});

	// Simple array:
	expected = [ 4, 5, 2, 2 ];
	actual = sample( [ 1, 2, 3, 4, 5, 6 ], {
		'size': 4,
		'probs': [ 1/12, 2/6, 2/6, 1/12, 1/12, 1/12 ]
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 4, 'returned array has four elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	// Typed array:
	expected = [ 5, 4, 5, 2, 2 ];
	actual = sample( new Int8Array( [ 1, 2, 3, 4, 5, 6 ] ), {
		'size': 5,
		'probs': [ 0.0, 1/12, 1/12, 3/6, 2/6, 0.0 ]
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 5, 'returned array has five elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	expected = [ 1, 3, 1, 1, 3 ];
	actual = sample( new Int8Array( [ 1, 2, 3, 4 ] ), {
		'size': 5,
		'probs': [ 0.5, 0.2, 0.2, 0.1 ]
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 5, 'returned array has five elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});

tape( 'the returned function draws a sample from an array using specified probabilities (without replacement)', function test( t ) {
	var expected;
	var actual;
	var sample;

	sample = factory({
		'seed': 589
	});

	// Simple array:
	expected = [ 3, 6, 5 ];
	actual = sample( [ 1, 2, 3, 4, 5, 6 ], {
		'size': 3,
		'probs': [ 1/12, 2/6, 2/6, 1/12, 1/12, 1/12 ],
		'replace': false
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 3, 'returned array has three elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	// Typed array:
	expected = [ 6, 3, 2, 1 ];
	actual = sample( new Int8Array( [ 1, 2, 3, 4, 5, 6 ] ), {
		'size': 4,
		'probs': [ 1/12, 2/6, 2/6, 1/12, 1/12, 1/12 ],
		'replace': false
	});

	t.equal( isNumberArray( actual ), true, 'returns an array of numbers' );
	t.equal( actual.length, 4, 'returned array has four elements' );
	t.deepEqual( actual, expected, 'returned array is a random draw' );

	t.end();
});
