'use strict';

// MODULES //

var debug = require( 'debug' )( 'time-series:engine' );
var EventEmitter = require( 'events' ).EventEmitter;
var scales = require( 'd3-scale' );
var shapes = require( 'd3-shape' );
var d3 = require( 'd3' );
var setReadOnly = require( '@stdlib/utils/define-read-only-property' );
var copy = require( '@stdlib/utils/copy' );
var minstd = require( '@stdlib/math/base/random/minstd' );
var validate = require( './validate.js' );
var defaults = require( './defaults.json' );


// TIME SERIES ENGINE //

/**
* Time series engine constructor.
*
* @constructor
* @param {Object} state - engine state
* @param {Options} [options] - constructor options
* TODO
* @throws {TypeError} must provide valid options
* @returns {Engine}
*
* @example
* var engine = new TimeSeriesEngine( TODO );
*/
function TimeSeriesEngine( state, options ) {
	var self;
	var opts;
	var err;
	if ( !( this instanceof TimeSeriesEngine ) ) {
		if ( arguments.length > 1 ) {
			return new TimeSeriesEngine( state, options );
		}
		return new TimeSeriesEngine( state );
	}
	self = this;
	opts = copy( defaults );
	if ( arguments.length > 1 ) {
		err = validate( opts, options );
		if ( err ) {
			throw err;
		}
	}
	debug( 'Creating a time series engine with the following configuration: %s.', JSON.stringify( opts ) );
	EventEmitter.call( this );

	// Public, read-only properties...
	setReadOnly( this, 'state', state );
	setReadOnly( this, 'opts', opts );
	setReadOnly( this, 'xScale', scales.scaleTime() );
	setReadOnly( this, 'yScale', scales.scaleLinear() );
	setReadOnly( this, 'xAxis', d3.svg.axis() ); // TODO: replace
	setReadOnly( this, 'yAxis', d3.svg.axis() ); // TODO: replace
	setReadOnly( this, 'line', shapes.line() );

	// Public, non-configurable properties...
	Object.defineProperty( this, 'xTickFormat', {
		'configurable': false,
		'enumerable': true,
		'writable': true,
		'value': null
	});
	Object.defineProperty( this, 'yTickFormat', {
		'configurable': false,
		'enumerable': true,
		'writable': true,
		'value': null
	});

	// "Private" properties...
	Object.defineProperty( this, '__uid__', {
		'configurable': false,
		'enumerable': false,
		'writable': false,
		'value': minstd().toString() // TODO: uuid
	});
	Object.defineProperty( this, '_clipPathID', {
		'configurable': false,
		'enumerable': false,
		'writable': false,
		'value': minstd().toString() // TODO: uuid
	});

	// Synchronize the engine state:
	this.sync(); // HACK

	// Bind a listener to update on state changes:
	this.state.on( 'change', onChange );

	return this;

	function onChange() {
		self.sync(); // HACK
		self.render();
	}
} // end FUNCTION TimeSeriesEngine()

/*
* Create a prototype which inherits from the parent prototype.
*/
TimeSeriesEngine.prototype = Object.create( EventEmitter.prototype );

/*
* Set the constructor.
*/
TimeSeriesEngine.prototype.constructor = TimeSeriesEngine;

/**
* Computes the expected graph width.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name graphWidth
* @returns {number} graph width
*/
setReadOnly( TimeSeriesEngine.prototype, 'graphWidth', require( './methods/graphwidth.js' ) );

/**
* Computes the expected graph height.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name graphHeight
* @returns {number} graph height
*/
setReadOnly( TimeSeriesEngine.prototype, 'graphHeight', require( './methods/graphheight.js' ) );

/**
* Maps a value to a pixel value along the x-direction.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name xPos
* @param {number} d - datum
* @returns {number} pixel value
*/
setReadOnly( TimeSeriesEngine.prototype, 'xPos', require( './methods/xpos.js' ) );

/**
* Maps a value to a pixel value along the y-direction.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name yPos
* @param {number} d - datum
* @returns {number} pixel value
*/
setReadOnly( TimeSeriesEngine.prototype, 'yPos', require( './methods/ypos.js' ) );

/**
* Computes the minimum value of the x-axis domain.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name xMin
* @returns {number} minimum value
*/
setReadOnly( TimeSeriesEngine.prototype, 'xMin', require( './methods/xmin.js' ) );

/**
* Computes the maximum value of the x-axis domain.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name xMax
* @returns {number} maximum value
*/
setReadOnly( TimeSeriesEngine.prototype, 'xMax', require( './methods/xmax.js' ) );

/**
* Computes the x-axis domain.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name xDomain
* @returns {NumberArray} domain
*/
setReadOnly( TimeSeriesEngine.prototype, 'xDomain', require( './methods/xdomain.js' ) );

/**
* Computes the x-axis range.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name xRange
* @returns {NumberArray} range
*/
setReadOnly( TimeSeriesEngine.prototype, 'xRange', require( './methods/xrange.js' ) );

/**
* Computes the minimum value of the y-axis domain.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name yMin
* @returns {number} minimum value
*/
setReadOnly( TimeSeriesEngine.prototype, 'yMin', require( './methods/ymin.js' ) );

/**
* Computes the maximum value of the y-axis domain.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name yMax
* @returns {number} maximum value
*/
setReadOnly( TimeSeriesEngine.prototype, 'yMax', require( './methods/ymax.js' ) );

/**
* Computes the y-axis domain.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name yDomain
* @returns {NumberArray} domain
*/
setReadOnly( TimeSeriesEngine.prototype, 'yDomain', require( './methods/ydomain.js' ) );

/**
* Computes the y-axis range.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name yRange
* @returns {NumberArray} range
*/
setReadOnly( TimeSeriesEngine.prototype, 'yRange', require( './methods/yrange.js' ) );

/**
* Generates a triangle as an SVG path.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name triangle
* @param {number} d - datum
* @returns {string} SVG path string
*/
setReadOnly( TimeSeriesEngine.prototype, 'triangle', require( './methods/triangle.js' ) );

/**
* Generates a vertical line as an SVG path.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name vline
* @param {number} d - datum
* @returns {string} SVG path string
*/
setReadOnly( TimeSeriesEngine.prototype, 'vline', require( './methods/vline.js' ) );

/**
* Syncs state.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name sync
*/
setReadOnly( TimeSeriesEngine.prototype, 'sync', require( './methods/sync.js' ) );

/**
* Renders a time series plot.
*
* @memberof TimeSeries.prototype
* @type {Function}
* @name render
* @returns {VTree} virtual tree
*/
setReadOnly( TimeSeriesEngine.prototype, 'render', require( './methods/render.js' ) );


// EXPORTS //

module.exports = TimeSeriesEngine;
