/**
* @license Apache-2.0
*
* Copyright (c) 2018 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

'use strict';

// MODULES //

var EventEmitter = require( 'events' ).EventEmitter;
var logger = require( 'debug' );
var getKeys = require( 'object-keys' ).shim();
var inherit = require( '@stdlib/utils/inherit' );
var copy = require( '@stdlib/utils/copy' );
var mergeFcn = require( '@stdlib/utils/merge' ).factory;
var setReadOnly = require( '@stdlib/utils/define-read-only-property' );
var isObject = require( '@stdlib/assert/is-plain-object' );
var minstd = require( '@stdlib/random/base/minstd' );
var defaults = require( './defaults.js' );
var view = require( './view' );


// VARIABLES //

var debug = logger( 'hist:main' );
var PRIVATE_PROPS = [
	'_autoRender',
	'_autoView',
	'_barColors',
	'_barOpacity',
	'_binCounts',
	'_binMethod',
	'_binWidth',
	'_description',
	'_edgeMax',
	'_edgeMin',
	'_edges',
	'_engine',
	'_height',
	'_isDefined',
	'_labels',
	'_lineColors',
	'_lineOpacity',
	'_lineStyle',
	'_lineWidth',
	'_nbins',
	'_normalization',
	'_orientation',
	'_paddingBottom',
	'_paddingLeft',
	'_paddingRight',
	'_paddingTop',
	'_renderFormat',
	'_title',
	'_viewer',
	'_width',
	'_xAxisOrient',
	'_xData',
	'_xLabel',
	'_xMax',
	'_xMin',
	'_xNumTicks',
	'_xScale',
	'_xTickFormat',
	'_yAxisOrient',
	'_yData',
	'_yLabel',
	'_yMax',
	'_yMin',
	'_yNumTicks',
	'_yScale',
	'_yTickFormat'
];


// FUNCTIONS //

var merge = mergeFcn({
	'extend': false
});


// MAIN //

/**
* Histogram constructor.
*
* @constructor
* @param {Array} [x] - values to bin
* @param {Array} [bins] - edges and/or number of bins
* @param {Options} [options] - constructor options
* @param {boolean} [options.autoRender=true] - indicates whether to re-render on a change event
* @param {boolean} [options.autoView=false] - indicates whether to generate an updated view on a render event
* @param {(string|StringArray)} [options.barColors='category10'] - bar face color(s)
* @param {(number|NumberArray)} [options.barOpacity=0.9] - bar face opacity
* @param {(null|string|Array)} [options.binMethod=null] - binning algorithm
* @param {(number|NumberArray)} [options.binWidth] - bin width
* @param {string} [options.description=''] - description
* @param {(null|number|Array)} [options.edgeMax=null] - maximum bin edge value
* @param {(null|number|Array)} [options.edgeMin=null] - minimum bin edge value
* @param {Array} [options.edges] - bin edges
* @param {string} [options.engine='svg'] - render engine
* @param {PositiveNumber} [options.height=400] - plot height
* @param {Function} [options.isDefined] - accessor indicating whether a datum is defined
* @param {(StringArray|EmptyArray)} [options.labels] - data labels
* @param {(string|StringArray)} [options.lineColors='#000'] - line color(s)
* @param {(number|NumberArray)} [options.lineOpacity=0.9] - line opacity
* @param {(string|StringArray)} [options.lineStyle='-'] - line style(s)
* @param {(NonNegativeInteger|Array<NonNegativeInteger>)} [options.lineWidth=2] - line width(s)
* @param {(null|number|Array)} [options.nbins] - number of bins
* @param {(string|StringArray)} [options.normalization='count'] - histogram normalization
* @param {string} [options.orientation='vertical'] - histogram orientation
* @param {NonNegativeInteger} [options.paddingBottom=80] - bottom padding
* @param {NonNegativeInteger} [options.paddingLeft=90] - left padding
* @param {NonNegativeInteger} [options.paddingRight=20] - right padding
* @param {NonNegativeInteger} [options.paddingTop=80] - top padding
* @param {string} [options.renderFormat='vdom'] - render format
* @param {string} [options.title=''] - title
* @param {string} [options.viewer='none'] - viewer
* @param {PositiveNumber} [options.width=400] - plot width
* @param {Array} [options.x=[]] - values to bin
* @param {string} [options.xAxisOrient='bottom'] - x-axis orientation
* @param {string} [options.xLabel='x'] - x-axis label
* @param {(Date|FiniteNumber|null)} [options.xMax=null] - maximum value of x-axis domain
* @param {(Date|FiniteNumber|null)} [options.xMin=null] - minimum value of x-axis domain
* @param {(NonNegativeInteger|null)} [options.xNumTicks=5] - number of x-axis tick marks
* @param {(string|null)} [options.xTickFormat=null] - x-axis tick format
* @param {string} [options.yAxisOrient='left'] - y-axis orientation
* @param {(null|string)} [options.yLabel=null] - y-axis label
* @param {(FiniteNumber|null)} [options.yMax=null] - maximum value of y-axis domain
* @param {(FiniteNumber|null)} [options.yMin=null] - minimum value of y-axis domain
* @param {(NonNegativeInteger|null)} [options.yNumTicks=5] - number of y-axis tick marks
* @param {(string|null)} [options.yTickFormat=null] - y-axis tick format
* @throws {TypeError} must provide valid options
* @returns {Histogram} Histogram instance
*
* @example
* TODO
*/
function Histogram() {
	var options;
	var nargs;
	var keys;
	var self;
	var opts;
	var key;
	var i;

	nargs = arguments.length;
	if ( !(this instanceof Histogram) ) {
		if ( nargs === 0 ) {
			return new Histogram();
		}
		if ( nargs === 1 ) {
			return new Histogram( arguments[0] );
		}
		if ( nargs === 2 ) {
			return new Histogram( arguments[0], arguments[1] );
		}
		return new Histogram( arguments[0], arguments[1], arguments[2] );
	}
	self = this;

	opts = defaults();
	if ( nargs === 0 ) {
		options = {};
	} else if ( nargs === 1 ) {
		options = arguments[ 0 ];
		if ( !isObject( options ) ) {
			throw new TypeError( 'invalid input argument. Options argument must be an `object`. Value: `' + options + '`.' );
		}
	} else if ( nargs === 2 ) {
		options = {};
		options.x = arguments[ 0 ];
		options.bins = arguments[ 1 ];
	} else if ( nargs > 2 ) {
		if ( !isObject( arguments[ 2 ] ) ) {
			throw new TypeError( 'invalid input argument. Options argument must be an `object`. Value: `' + arguments[2] + '`.' );
		}
		options = copy( arguments[ 2 ] ); // avoid mutation
		options.x = arguments[ 0 ];
		options.bins = arguments[ 1 ];
	}
	opts = merge( opts, options );

	debug( 'Creating an instance with the following configuration: %s.', JSON.stringify( opts ) );
	EventEmitter.call( this );

	for ( i = 0; i < PRIVATE_PROPS.length; i++ ) {
		Object.defineProperty( this, PRIVATE_PROPS[i], {
			'configurable': false,
			'enumerable': false,
			'writable': true,
			'value': null
		});
	}
	// Set a clipping path id:
	Object.defineProperty( this, '_clipPathId', {
		'configurable': false,
		'enumerable': false,
		'writable': false,
		'value': minstd().toString() // TODO: uuid
	});

	// Initialize an internal cache for renderers...
	Object.defineProperty( this, '$', {
		'configurable': false,
		'enumerable': false,
		'writable': false,
		'value': {}
	});
	Object.defineProperty( this.$, 'svg', {
		'configurable': false,
		'enumerable': false,
		'writable': false,
		'value': {}
	});

	// Set options...
	keys = getKeys( opts );
	for ( i = 0; i < keys.length; i++ ) {
		key = keys[ i ];
		this[ key ] = opts[ key ];
	}

	// Add event listeners:
	this.on( 'change', onChange );
	this.on( 'render', onRender );

	return this;

	/**
	* Callback invoked upon receiving a change event.
	*
	* @private
	*/
	function onChange() {
		/* eslint-disable no-underscore-dangle */
		debug( 'Received a change event.' );
		if ( self._autoRender ) {
			self.render();
		}
	}

	/**
	* Callback invoked upon receiving a render event.
	*
	* @private
	* @param {*} hist - rendered histogram
	*/
	function onRender( hist ) {
		/* eslint-disable no-underscore-dangle */
		debug( 'Received a render event.' );
		if ( self._autoView ) {
			debug( 'Viewer: %s.', self._viewer );
			debug( 'Generating view...' );
			view( self, self._viewer, hist );
		}
	}
}

/*
* Inherit from the `EventEmitter` prototype.
*/
inherit( Histogram, EventEmitter );

/**
* Rendering mode.
*
* ## Notes
*
* -   If `true`, an instance re-renders on each `'change'` event.
*
* @name autoRender
* @memberof Histogram.prototype
* @type {boolean}
* @throws {TypeError} must be a boolean primitive
* @default true
*
* @example
* var hist = new Histogram({
*     'autoRender': true
* });
*
* var mode = hist.autoRender;
* // returns true
*/
Object.defineProperty( Histogram.prototype, 'autoRender', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/auto-render/set.js' ),
	'get': require( './props/auto-render/get.js' )
});

/**
* Viewer mode.
*
* ## Notes
*
* -   If `true`, an instance generates an updated view on each render event.
*
* @name autoView
* @memberof Histogram.prototype
* @type {boolean}
* @throws {TypeError} must be a boolean primitive
* @default false
*
* @example
* var hist = new Histogram({
*     'autoView': false
* });
*
* var mode = hist.autoView;
* // returns false
*/
Object.defineProperty( Histogram.prototype, 'autoView', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/auto-view/set.js' ),
	'get': require( './props/auto-view/get.js' )
});

/**
* Histogram description.
*
* @name description
* @memberof Histogram.prototype
* @type {string}
* @throws {TypeError} must be a string primitive
* @default ''
*
* @example
* var hist = new Histogram();
* hist.description = 'FRET histograms.';
*
* @example
* var hist = new Histogram({
*     'description': 'A histogram description.'
* });
* var desc = hist.description;
* // returns 'A histogram description'
*/
Object.defineProperty( Histogram.prototype, 'description', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/description/set.js' ),
	'get': require( './props/description/get.js' )
});

/**
* Render engine.
*
* @name engine
* @memberof Histogram.prototype
* @type {string}
* @throws {TypeError} must be a recognized engine
* @default 'svg'
*
* @example
* var hist = new Histogram();
* hist.engine = 'svg';
*
* @example
* var hist = new Histogram({
*     'engine': 'svg'
* });
* var engine = hist.engine;
* // returns 'svg'
*/
Object.defineProperty( Histogram.prototype, 'engine', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/engine/set.js' ),
	'get': require( './props/engine/get.js' )
});

/**
* Expected graph height.
*
* @name graphHeight
* @memberof Histogram.prototype
* @type {number}
*
* @example
* var hist = new Histogram({
*     'height': 100,
*     'paddingTop': 10,
*     'paddingBottom': 20
* });
* var height = hist.graphHeight;
* // returns 70
*/
Object.defineProperty( Histogram.prototype, 'graphHeight', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/graph-height/get.js' )
});

/**
* Expected graph width.
*
* @name graphWidth
* @memberof Histogram.prototype
* @type {number}
*
* @example
* var hist = new Histogram({
*     'width': 100,
*     'paddingLeft': 10,
*     'paddingRight': 10
* });
* var width = hist.graphWidth;
* // returns 80
*/
Object.defineProperty( Histogram.prototype, 'graphWidth', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/graph-width/get.js' )
});

/**
* Plot height.
*
* @name height
* @memberof Histogram.prototype
* @type {PositiveNumber}
* @throws {TypeError} must be a positive number
* @default 400 (px)
*
* @example
* var hist = new Histogram();
* hist.height = 100;
*
* @example
* var hist = new Histogram({
*     'height': 360
* });
* var height = hist.height;
* // returns 360
*/
Object.defineProperty( Histogram.prototype, 'height', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/height/set.js' ),
	'get': require( './props/height/get.js' )
});

/**
* Accessor which defines whether a datum is defined.
*
* ## Notes
*
* -   This accessor is used to define how missing values are encoded.
* -   The default behavior is to ignore values which are `NaN`.
*
* @name isDefined
* @memberof Histogram.prototype
* @type {Function}
* @param {*} d - datum
* @param {integer} i - index
* @throws {TypeError} must be a function
*
* @example
* var hist = new Histogram();
* hist.isDefined = function isDefined( d ) {
*     // Check for `NaN`:
*     return ( d === d );
* }
*
* @example
* function isDefined( d ) {
*     // Check for `NaN`:
*     return ( d === d );
* }
* var hist = new Histogram({
*     'isDefined': isDefined
* });
* var fcn = hist.isDefined;
* // returns <Function>
*/
Object.defineProperty( Histogram.prototype, 'isDefined', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/is-defined/set.js' ),
	'get': require( './props/is-defined/get.js' )
});

/**
* Data labels.
*
* @name labels
* @memberof Histogram.prototype
* @type {(StringArray|EmptyArray)}
* @throws {TypeError} must be either an array of strings or an empty array
* @default []
*
* @example
* var hist = new Histogram();
* hist.labels = [ 'beep', 'boop' ];
*
* @example
* var hist = new Histogram({
*     'labels': [ 'beep', 'boop' ]
* });
* var labels = hist.labels;
* // returns [ 'beep', 'boop' ]
*/
Object.defineProperty( Histogram.prototype, 'labels', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/labels/set.js' ),
	'get': require( './props/labels/get.js' )
});

/**
* Line opacity.
*
* ## Notes
*
* -   When retrieved, the returned value is always an `array`.
*
* @name lineOpacity
* @memberof Histogram.prototype
* @type {(number|NumberArray)}
* @throws {TypeError} must be a number or number array
* @throws {RangeError} must be a number on the interval `[0,1]`
* @default '0.9'
*
* @example
* var hist = new Histogram();
* hist.lineOpacity = [ 1.0, 0.5 ];
*
* @example
* var hist = new Histogram({
*     'lineOpacity': 0.5
* });
* var opacity = hist.lineOpacity;
* // returns [ 0.5 ]
*/
Object.defineProperty( Histogram.prototype, 'lineOpacity', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/line-opacity/set.js' ),
	'get': require( './props/line-opacity/get.js' )
});

/**
* Line style(s).
*
* ## Notes
*
* -   When retrieved, the returned value is always an `array`.
*
* @name lineStyle
* @memberof Histogram.prototype
* @type {(string|StringArray)}
* @throws {TypeError} must be a string or string array
* @throws {Error} must be a supported line style
* @default '-'
*
* @example
* var hist = new Histogram();
* hist.lineStyle = [ '-', 'none' ];
*
* @example
* var hist = new Histogram({
*     'lineStyle': 'none'
* });
* var lineStyle = hist.lineStyle;
* // returns [ 'none' ]
*/
Object.defineProperty( Histogram.prototype, 'lineStyle', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/line-style/set.js' ),
	'get': require( './props/line-style/get.js' )
});

/**
* Line width.
*
* ## Notes
*
* -   When retrieved, the returned value is always an `array`.
*
* @name lineWidth
* @memberof Histogram.prototype
* @type {(NonNegativeInteger|NonNegativeIntegerArray)}
* @throws {TypeError} must be a nonnegative integer or nonnegative integer array
* @default 2
*
* @example
* var hist = new Histogram();
* hist.lineWidth = 1;
*
* @example
* var hist = new Histogram({
*     'lineWidth': [ 1, 3 ]
* });
* var width = hist.lineWidth;
* // returns [ 1, 3 ]
*/
Object.defineProperty( Histogram.prototype, 'lineWidth', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/line-width/set.js' ),
	'get': require( './props/line-width/get.js' )
});

/**
* Plot bottom padding.
*
* ## Notes
*
* -   Typically used to create space for a bottom-oriented y-axis.
*
* @name paddingBottom
* @memberof Histogram.prototype
* @type {NonNegativeInteger}
* @throws {TypeError} must be a nonnegative integer
* @default 80 (px)
*
* @example
* var hist = new Histogram();
* hist.paddingBottom = 100;
*
* @example
* var hist = new Histogram({
*     'paddingBottom': 100
* });
* var padding = hist.paddingBottom;
* // returns 100
*/
Object.defineProperty( Histogram.prototype, 'paddingBottom', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/padding-bottom/set.js' ),
	'get': require( './props/padding-bottom/get.js' )
});

/**
* Plot left padding.
*
* ## Notes
*
* -   Typically used to create space for a left-oriented y-axis.
*
* @name paddingLeft
* @memberof Histogram.prototype
* @type {NonNegativeInteger}
* @throws {TypeError} must be a nonnegative integer
* @default 90 (px)
*
* @example
* var hist = new Histogram();
* hist.paddingLeft = 100;
*
* @example
* var hist = new Histogram({
*     'paddingLeft': 100
* });
* var padding = hist.paddingLeft;
* // returns 100
*/
Object.defineProperty( Histogram.prototype, 'paddingLeft', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/padding-left/set.js' ),
	'get': require( './props/padding-left/get.js' )
});

/**
* Plot right padding.
*
* ## Notes
*
* -   Typically used to create space for a right-oriented y-axis.
*
* @name paddingRight
* @memberof Histogram.prototype
* @type {NonNegativeInteger}
* @throws {TypeError} must be a nonnegative integer
* @default 20 (px)
*
* @example
* var hist = new Histogram();
* hist.paddingRight = 100;
*
* @example
* var hist = new Histogram({
*     'paddingRight': 100
* });
* var padding = hist.paddingRight;
* // returns 100
*/
Object.defineProperty( Histogram.prototype, 'paddingRight', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/padding-right/set.js' ),
	'get': require( './props/padding-right/get.js' )
});

/**
* Plot top padding.
*
* ## Notes
*
* -   Typically used to create space for a title or top-oriented x-axis.
*
* @name paddingTop
* @memberof Histogram.prototype
* @type {NonNegativeInteger}
* @throws {TypeError} must be a nonnegative integer
* @default 80 (px)
*
* @example
* var hist = new Histogram();
* hist.paddingTop = 100;
*
* @example
* var hist = new Histogram({
*     'paddingTop': 100
* });
* var padding = hist.paddingTop;
* // returns 100
*/
Object.defineProperty( Histogram.prototype, 'paddingTop', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/padding-top/set.js' ),
	'get': require( './props/padding-top/get.js' )
});

/**
* Render format.
*
* @name renderFormat
* @memberof Histogram.prototype
* @type {string}
* @throws {TypeError} must be a recognized format
* @default 'vdom'
*
* @example
* var hist = new Histogram();
* hist.renderFormat = 'vdom';
*
* @example
* var hist = new Histogram({
*     'renderFormat': 'html'
* });
* var fmt = hist.renderFormat;
* // returns 'html'
*/
Object.defineProperty( Histogram.prototype, 'renderFormat', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/render-format/set.js' ),
	'get': require( './props/render-format/get.js' )
});

/**
* Plot title.
*
* @name title
* @memberof Histogram.prototype
* @type {string}
* @throws {TypeError} must be a string primitive
* @default ''
*
* @example
* var hist = new Histogram();
* hist.title = 'Histogram';
*
* @example
* var hist = new Histogram({
*     'title': 'Histogram'
* });
* var t = hist.title;
* // returns 'Histogram'
*/
Object.defineProperty( Histogram.prototype, 'title', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/title/set.js' ),
	'get': require( './props/title/get.js' )
});

/**
* Histogram viewer.
*
* @name viewer
* @memberof Histogram.prototype
* @type {string}
* @throws {TypeError} must be a recognized viewer
* @default 'none'
*
* @example
* var hist = new Histogram();
* hist.viewer = 'none';
*
* @example
* var hist = new Histogram({
*     'viewer': 'none'
* });
* var viewer = hist.viewer;
* // returns 'none'
*/
Object.defineProperty( Histogram.prototype, 'viewer', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/viewer/set.js' ),
	'get': require( './props/viewer/get.js' )
});

/**
* Plot width.
*
* @name width
* @memberof Histogram.prototype
* @type {PositiveNumber}
* @throws {TypeError} must be a positive number
* @default 400 (px)
*
* @example
* var hist = new Histogram();
* hist.width = 100;
*
* @example
* var hist = new Histogram({
*     'width': 480
* });
* var width = hist.width;
* // returns 480
*/
Object.defineProperty( Histogram.prototype, 'width', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/width/set.js' ),
	'get': require( './props/width/get.js' )
});

/**
* x-axis orientation.
*
* @name xAxisOrient
* @memberof Histogram.prototype
* @type {string}
* @throws {TypeError} must be either `'top'` or `'bottom'`
* @default 'bottom'
*
* @example
* var hist = new Histogram();
* hist.xAxisOrient = 'bottom';
*
* @example
* var hist = new Histogram({
*     'xAxisOrient': 'bottom'
* });
* var orientation = hist.xAxisOrient;
* // returns 'bottom'
*/
Object.defineProperty( Histogram.prototype, 'xAxisOrient', {
	'configurable': false,
	'enumerable': true,
	'set': require( './props/x-axis-orient/set.js' ),
	'get': require( './props/x-axis-orient/get.js' )
});

/**
* x-axis domain.
*
* @name xDomain
* @memberof Histogram.prototype
* @type {Array}
*
* @example
* var hist = new Histogram({
*     'xMin': 0,
*     'xMax': 100
* });
* var domain = hist.xDomain;
* // returns [ 0, 100 ]
*/
Object.defineProperty( Histogram.prototype, 'xDomain', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/x-domain/get.js' )
});

/**
* Generates a histogram view.
*
* @name view
* @memberof Histogram.prototype
* @type {Function}
* @param {string} [viewer] - viewer
* @throws {TypeError} must provide a recognized viewer
*
* @example
* var hist = new Histogram();
* hist.x = [ [ 1, 2, 3 ] ];
* hist.view( 'stdout' );
*/
setReadOnly( Histogram.prototype, 'view', require( './view' ) );


// EXPORTS //

module.exports = Histogram;
