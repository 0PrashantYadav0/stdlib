'use strict';

// MODULES //

var debug = require( 'debug' )( 'axis:engine' );
var EventEmitter = require( 'events' ).EventEmitter;
var setReadOnly = require( '@stdlib/utils/define-read-only-property' );
var copy = require( '@stdlib/utils/copy' );
var validate = require( './validate.js' );
var defaults = require( './defaults.json' );


// ENGINE //

/**
* Engine constructor.
*
* @private
* @constructor
* @param {Object} state - engine state
* @param {Options} [options] - engine options
* @throws {TypeError} must provide valid options
* @returns {Engine} engine instance
*/
function Engine( state, options ) {
	var self;
	var opts;
	var err;
	if ( !( this instanceof Engine ) ) {
		if ( arguments.length > 1 ) {
			return new Engine( state, options );
		}
		return new Engine( state );
	}
	self = this;
	opts = copy( defaults );
	if ( arguments.length > 1 ) {
		err = validate( opts, options );
		if ( err ) {
			throw err;
		}
	}
	debug( 'Creating an engine with the following configuration: %s.', JSON.stringify( opts ) );
	EventEmitter.call( this );

	// Public, read-only properties...
	setReadOnly( this, 'state', state );

	// "Private" properties...
	Object.defineProperty( this, '_opts', {
		'configurable': false,
		'enumerable': false,
		'writable': false,
		'value': opts
	});

	// Bind a listener to update on state changes:
	this.state.on( 'change', onChange );

	return this;

	function onChange() {
		debug( 'Received a change event.' );

		// Check for a change in engine...
		if ( self.state.__engine__ !== self ) {
			debug( 'No longer using engine for rendering. Removing listener...' );
			return self.state.removeListener( 'change', onChange );
		}
		self.render();
	}
} // end FUNCTION Engine()

/*
* Create a prototype which inherits from the parent prototype.
*/
Engine.prototype = Object.create( EventEmitter.prototype );

/*
* Set the constructor.
*/
Engine.prototype.constructor = Engine;

/**
* Function for translating ticks.
*
* @memberof Engine.prototype
* @type {Function}
* @name transform
*/
Object.defineProperty( Engine.prototype, 'tickTransform', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/tick-transform/get.js' )
});

/**
* Vertical shift for positioning tick text.
*
* @memberof Engine.prototype
* @type {string}
* @name dy
*/
Object.defineProperty( Engine.prototype, 'dy', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/text-dy/get.js' )
});

/**
* Text anchor value for text positioning.
*
* @memberof Engine.prototype
* @type {string}
* @name textAnchor
*/
Object.defineProperty( Engine.prototype, 'textAnchor', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/text-anchor/get.js' )
});

/**
* SVG transform for positioning an axis label.
*
* @memberof Engine.prototype
* @type {string}
* @name labelTransform
*/
Object.defineProperty( Engine.prototype, 'labelTransform', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/label-transform/get.js' )
});

/**
* Label `x` coordinate.
*
* @memberof Engine.prototype
* @type {number}
* @name labelXPos
*/
Object.defineProperty( Engine.prototype, 'labelXPos', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/label-x-pos/get.js' )
});

/**
* Label `y` coordinate.
*
* @memberof Engine.prototype
* @type {number}
* @name labelXPos
*/
Object.defineProperty( Engine.prototype, 'labelYPos', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/label-y-pos/get.js' )
});

/**
* "x" attribute for tick positioning.
*
* @memberof Engine.prototype
* @type {string}
* @name xAttr
*/
Object.defineProperty( Engine.prototype, 'xAttr', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/x-attr/get.js' )
});

/**
* "y" attribute for tick positioning.
*
* @memberof Engine.prototype
* @type {string}
* @name yAttr
*/
Object.defineProperty( Engine.prototype, 'yAttr', {
	'configurable': false,
	'enumerable': true,
	'get': require( './props/y-attr/get.js' )
});

/**
* Renders an axis.
*
* @memberof Engine.prototype
* @type {Function}
* @name render
* @returns {VTree} virtual tree
*/
setReadOnly( Engine.prototype, 'render', require( './methods/render.js' ) );


// EXPORTS //

module.exports = Engine;
