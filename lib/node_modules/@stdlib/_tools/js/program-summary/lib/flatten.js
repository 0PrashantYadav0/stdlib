'use strict';

// MODULES //

var walk = require( 'acorn/dist/walk.js' ).fullAncestor;
var contains = require( '@stdlib/assert/contains' );
var types = require( './node_types.js' );


// MAIN //

/**
* Flattens an AST.
*
* @private
* @param {Node} ast - AST node
* @param {NonNegativeInteger} level - recursion level
* @returns {Array} flattened AST
*/
function flatten( ast, level ) {
	var out = [];
	walk( ast, visit );
	return out;

	/**
	* Callback invoked upon visiting an AST node.
	*
	* @private
	* @param {Node} node - AST node
	* @param {*} state - state
	* @param {Array<Node>} ancestors - ancestor nodes
	*/
	function visit( node, state, ancestors ) {
		var i;
		if ( node !== ast && contains( types, node.type ) ) {
			// For functions, track the function scope (i.e., level of function nesting):
			if ( node.type === 'FunctionDeclaration' ) {
				node.__scope_level__ = level; // eslint-disable-line no-underscore-dangle
				for ( i = 0; i < ancestors.length-1; i++ ) {
					if ( ancestors[ i ].type === 'FunctionDeclaration' ) {
						node.__scope_level__ += 1; // eslint-disable-line no-underscore-dangle
					}
				}
			}
			out.push( node );
		}
	} // end FUNCTION visit()
} // end FUNCTION flatten()


// EXPORTS //

module.exports = flatten;
