'use strict';

// MODULES //

var whitespace = require( './whitespace.js' );


// VARIABLES //

var RE_NON_WHITESPACE = /\S/;
var RE_JSDOC = /^\/\*\*$/; // Note: this is strict!


// MAIN //

/**
* Returns a callback to be invoked upon encountering a comment.
*
* @private
* @param {Object} results - results object
* @param {StringArray} lines - source code lines
* @returns {Function} callback to be invoked upon encountering a comment
*/
function wrap( results, lines ) {
	return onComment;

	/**
	* Callback invoked upon encountering a comment.
	*
	* @private
	* @param {boolean} block - boolean indicating whether a comment is a block comment
	* @param {string} text - comment text
	* @param {NonNegativeInteger} start - character offset for comment start
	* @param {NonNegativeInteger} end - character offset for comment end
	* @param {Object} pos1 - start location
	* @param {Object} pos2 - end location
	*/
	function onComment( block, text, start, end, pos1, pos2 ) {
		var inline;
		var wchars;
		var jsdoc;
		var line;
		var key;
		var len;
		var N;

		// Determine the number of lines:
		N = pos2.line - pos1.line + 1;

		// Determine the comment length:
		len = end - start;

		// Determine the number of whitespace characters:
		wchars = whitespace( text );

		// Determine if the comment is inline...
		if ( N === 1 ) {
			line = lines[ pos1.line-1 ];
			line = line.substring( 0, pos1.column );
			inline = RE_NON_WHITESPACE.test( line );
		} else {
			inline = false;
		}
		inline = ( inline ) ? 1 : 0;

		// Determine if the comment is a JSDoc block comment...
		if ( block ) {
			line = lines[ pos1.line-1 ];
			line = line.substring( pos1.column, pos1.column+3 ); // only the first 3 chars are needed
			jsdoc = RE_JSDOC.test( line );
		}
		// Update sub-comment totals:
		if ( block ) {
			key = 'block';
		} else {
			key = 'line';
		}
		results.comments[ key ].count += 1;
		results.comments[ key ].length += len;
		results.comments[ key ].whitespace += wchars;
		results.comments[ key ].lines += N;
		results.comments[ key ].inline += inline;

		if ( jsdoc ) {
			results.comments.jsdoc.count += 1;
			results.comments.jsdoc.length += len;
			results.comments.jsdoc.whitespace += wchars;
			results.comments.jsdoc.lines += N;
			results.comments.jsdoc.inline += inline;
		}
		// Update total comment totals:
		results.comments.count += 1;
		results.comments.length += len;
		results.comments.whitespace += wchars;
		results.comments.lines += N;
		results.comments.inline += inline;

		// Append a comment summary:
		results.comments.data.push({
			'type': key,
			'length': len,
			'whitespace': wchars,
			'lines': N,
			'inline': !!inline,
			'jsdoc': !!jsdoc
		});
	} // end FUNCTION onComment()
} // end FUNCTION wrap()


// EXPORTS //

module.exports = wrap;
