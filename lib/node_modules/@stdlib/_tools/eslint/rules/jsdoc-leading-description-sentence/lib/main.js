'use strict';

// MODULES //

var doctrine = require( 'doctrine' );
var isCapitalized = require( '@stdlib/assert/is-capitalized' );
var isObject = require( '@stdlib/assert/is-object' );
var contains = require( '@stdlib/assert/contains' );
var endsWith = require( '@stdlib/string/ends-with' );
var getJSDocComment = require( './get_jsdoc_comment' );


// MAIN //

/**
* Rule for validating that JSDoc descriptions start with an uppercase letter and end with a period.
*
* @param {Object} context - ESLint context
* @returns {Object} validators
*/
function main( context ) {
	var source = context.getSourceCode();

	/**
	* Reports the error message.
	*
	* @private
	* @param {Object} loc - lines of code (object with `start` and `end` properties)
	*/
	function report( loc ) {
		context.report({
			'node': null,
			'message': 'Description must start with an uppercase letter and end with a period',
			'loc': loc
		});
	} // end FUNCTION report()

	/**
	* Checks whether JSDOc comments have a capitalized description that ends with a period.
	*
	* @private
	* @param {ASTNode} node - node to examine
	*/
	function validate( node ) {
		var jsdoc;
		var descr;
		var ast;

		jsdoc = getJSDocComment( source, node );
		if ( isObject( jsdoc ) ) {
			ast = doctrine.parse( jsdoc.value, {
				'sloppy': true,
				'unwrap': true
			});
			descr = ast.description;
			if ( contains( descr, '\n' ) ) {
				// Only first line contains the description:
				descr = descr.substr( 0, descr.indexOf( '\n' ) );
			}
			if (
				// Do not raise an error for JSDoc comments without descriptions:
				descr.length &&
				( !isCapitalized( descr ) || !endsWith( descr, '.' ) )
			) {
				report( jsdoc.loc );
			}
		}
	} // end FUNCTION validate()

	return {
		'FunctionExpression:exit': validate,
		'FunctionDeclaration:exit': validate,
		'VariableDeclaration:exit': validate,
		'ExpressionStatement:exit': validate
	};
} // end FUNCTION main()


// EXPORTS //

module.exports = {
	'meta': {
		'docs': {
			'description': 'enforce that JSDoc descriptions start with an uppercase letter and end with a period'
		},
		'schema': []
	},
	'create': main
};
