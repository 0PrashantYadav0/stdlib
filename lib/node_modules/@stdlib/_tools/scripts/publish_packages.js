/**
* @license Apache-2.0
*
* Copyright (c) 2021 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

/* eslint-disable no-sync, no-console */

'use strict';

// MODULES //

var shell = require( 'child_process' ).execSync;
var join = require( 'path' ).join;
var fs = require( 'fs' );
var ghpages = require( 'gh-pages' );
var writeFileSync = require( '@stdlib/fs/write-file' ).sync;
var readFileSync = require( '@stdlib/fs/read-file' ).sync;
var readJSON = require( '@stdlib/fs/read-json' ).sync;
var replace = require( '@stdlib/string/replace' );
var startsWith = require( '@stdlib/string/starts-with' );
var namespaceDeps = require( '@stdlib/_tools/pkgs/namespace-deps' );


// VARIABLES //

// TODO: Edit the list of packages that will be published:
var PACKAGES_TO_PUBLISH = [
	'math/base/special'

	// 'regexp'

	/*
	'assert/is-undefined'
	'utils',
	'assert',
	'ndarray',
	'bench'
	*/
];
var INSTALLATION_SECTION = [
	'<section class="installation">',
	'',
	'## Installation',
	'',
	'``` bash',
	'$ npm install @stdlib/<pkg>',
	'```',
	'',
	'</section>',
	''
].join( '\n' );

var MAIN_REPO_SECTION = [
	'',
	'<section class="main-repo" >',
	'',
	'* * *',
	'',
	'## Notice',
	'',
	'This package is part of [stdlib][stdlib], a standard library for JavaScript and Node.js, with an emphasis on numerical and scientific computing. The library provides a collection of robust, high performance libraries for mathematics, statistics, streams, utilities, and more.',
	'',
	'For more information on the project, filing bug reports and feature requests, and guidance on how to develop [stdlib][stdlib], see the main project [repository][stdlib].',
	'',
	'---',
	'',
	'## License',
	'',
	'See [LICENSE][stdlib-license].',
	'',
	'',
	'## Copyright',
	'',
	'Copyright &copy; 2016-2021. The Stdlib [Authors][stdlib-authors].',
	'',
	'</section>',
	'',
	'<!-- /.stdlib -->',
	'',
	'<!-- Section for all links. Make sure to keep an empty line after the `section` element and another before the `/section` close. -->',
	'',
	'<section class="links">',
	'',
	'[stdlib]: https://github.com/stdlib-js/stdlib',
	'',
	'[stdlib-authors]: https://github.com/stdlib-js/stdlib/graphs/contributors',
	'',
	'[stdlib-license]: https://raw.githubusercontent.com/stdlib-js/<pkg>/main/LICENSE'
].join( '\n' );

var mainDir = join( __dirname, '..', '..', '..', '..', '..' );
var DOTFILES = [ '.editorconfig', '.npmignore', '.npmrc', 'CONTRIBUTORS', 'LICENSE', 'NOTICE' ];

var WORKFLOW = [
	'name: Publish Package to npm',
	'',
	'on: push',
	'',
	'jobs:',
	'  publish:',
	'    runs-on: ubuntu-latest',
	'    steps:',
	'      - uses: actions/checkout@v1',
	'      - uses: actions/setup-node@v1',
	'        with:',
	'          node-version: 10',
	'      - name: Increment version',
	'        run: |',
	'          git config --local user.email "noreply@stdlib.io"',
	'          git config --local user.name "stdlib-bot"',
	'          npm version patch',
	'      - name: Push changes',
	'        uses: ad-m/github-push-action@master',
	'        with:',
	'          github_token: ${{ secrets.GITHUB_TOKEN }}',
	'          branch: ${{ github.ref }}',
	'          tags: true',
	'      - name: Publish package to npm',
	'        uses: JS-DevTools/npm-publish@v1',
	'        with:',
	'          token: ${{ secrets.NPM_TOKEN }}'
].join( '\n' );


// FUNCTIONS //

/**
* Publishes a package to the respective GitHub repository.
*
* @private
* @param {string} pkg - package name
* @param {Function} clbk - callback function
* @returns {void}
*/
function publish( pkg, clbk ) {
	var workflowPath;
	var pkgJsonPath;
	var replacement;
	var readmePath;
	var mainJSON;
	var command;
	var devDeps;
	var distPkg;
	var pkgJSON;
	var version;
	var readme;
	var deps;
	var dist;
	var file;
	var dep;
	var src;
	var i;

	src = join( mainDir, 'lib/node_modules', '@stdlib', pkg );
	distPkg = replace( pkg, /\//g, '-' );
	dist = join( mainDir, 'build', '@stdlib', distPkg );
	mainJSON = readJSON( join( mainDir, 'package.json' ) );

	shell( 'mkdir -p '+dist );
	shell( 'cp -r '+src+'/* '+dist );
	for ( i = 0; i < DOTFILES.length; i++ ) {
		file = DOTFILES[ i ];
		fs.copyFileSync( join( mainDir, file ), join( dist, file ) );
	}

	readmePath = join( dist, 'README.md' );
	readme = readFileSync( readmePath, 'utf-8' );
	replacement = INSTALLATION_SECTION+'\n<section class="usage">';
	readme = replace( readme, '<section class="usage">', replacement );
	readme = replace( readme, '@stdlib/'+pkg, '@stdlib/'+distPkg );
	readme = replace( readme, '<section class="links">', MAIN_REPO_SECTION );
	readme = replace( readme, '<pkg>', distPkg );
	writeFileSync( readmePath, readme );

	command = [
		'find '+dist+' -type f -name \'*.md\' -print0 ', // Find all regular Markdown files in the destination directory and print their full names to standard output...
		'| xargs -0 ', // Convert standard input to the arguments for following `sed` command...
		'sed -Ei ', // Edit files in-place without creating a backup...
		'\'s/',
		'(@stdlib\\/'+distPkg+')([^:]*)\\]:.*$', // Match start of internal package link until end of line...
		'/',
		'\\1\\2]: https:\\/\\/github.com\\/stdlib-js\\/'+distPkg+'\\/tree\\/main\\2', // Replacement string generated via back-referencing the two created capture groups...
		'/g\'' // Replace all occurences and not just the first...
	].join( '' );
	shell( command );

	pkgJsonPath = join( dist, 'package.json' );
	pkgJSON = readJSON( pkgJsonPath );
	pkgJSON.name = '@stdlib/'+distPkg;
	pkgJSON.repository.url = 'git://github.com/stdlib-js/'+distPkg+'.git';
	try {
		version = shell( 'npm view @stdlib/'+pkg+' version' ).toString();
	} catch ( err ) {
		console.error( err );
		version = '0.0.0';
	}
	pkgJSON.version = version;

	deps = namespaceDeps( '@stdlib/'+pkg, {
		'level': 20,
		'dev': false
	});
	devDeps = namespaceDeps( '@stdlib/'+pkg, {
		'level': 20,
		'dev': true
	});
	for ( i = 0; i < deps.length; i++ ) {
		dep = deps[ i ];
		if ( startsWith( dep, '@stdlib' ) ) {
			pkgJSON.dependencies[ dep ] = '^0.0.x';
		} else {
			pkgJSON.dependencies[ dep ] = mainJSON.dependencies[ dep ];
		}
	}
	for ( i = 0; i < devDeps.length; i++ ) {
		dep = devDeps[ i ];
		if ( startsWith( dep, '@stdlib' ) ) {
			pkgJSON.devDependencies[ dep ] = '^0.0.x';
		} else {
			pkgJSON.devDependencies[ dep ] = mainJSON.devDependencies[ dep ];
		}
	}
	writeFileSync( pkgJsonPath, JSON.stringify( pkgJSON, null, '  ' ) );
	fs.mkdirSync( join( dist, '.github', 'workflows' ), {
		'recursive': true
	});
	workflowPath = join( dist, '.github', 'workflows', 'npm-publish.yml' );
	writeFileSync( workflowPath, WORKFLOW );

	ghpages.publish( dist, {
		'branch': 'main',
		'dotfiles': true,
		'src': [
			'**/*',
			'!**/.cache/**',
			'package.json',
			'README.md'
		],
		'repo': 'https://github.com/stdlib-js/' + replace( pkg, '/', '-' ),
		'message': 'Auto-generated commit',
		'user': {
			'name': 'stdlib-bot',
			'email': 'noreply@stdlib.io'
		},
		'history': true,
		'remove': 'node_modules/*'
	}, clbk );
}


// MAIN //

/**
* Main execution sequence.
*
* @private
* @returns {void}
*/
function main() {
	var pkg = PACKAGES_TO_PUBLISH.shift();
	publish( pkg, onCallback );

	/**
	* Callback invoked once pushing package contents to remote GitHub repository.
	*
	* @private
	* @param {Error} err - error object or `null`
	* @returns {void}
	*/
	function onCallback( err ) {
		if ( err ) {
			return console.error( err );
		}
		pkg = PACKAGES_TO_PUBLISH.shift();
		if ( pkg ) {
			publish( pkg, onCallback );
		}
	}
}

main();
