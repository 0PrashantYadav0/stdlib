/**
* @license Apache-2.0
*
* Copyright (c) 2018 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

'use strict';

// MODULES //

var logger = require( 'debug' );
var lunr = require( 'lunr' );
var lowercase = require( '@stdlib/string/lowercase' );
var replace = require( '@stdlib/string/replace' );
var dirname = require( '@stdlib/utils/dirname' );
var sectionText = require( './section_text.js' );


// VARIABLES //

var debug = logger( 'seach:pkg-index:create' );
var RE_TITLE = /#[ ]*([^\n]+)\r?\n/;
var RE_DESC = />[ ]*([^\n]+)\r?\n/;
var RE_LINKS = /\[([^\]]+)\]\[[^\]]+\]/g;
var RE_TRAILING_PERIOD = /\.$/;


// FUNCTIONS //

/**
* Returns the last index of a specified string.
*
* ## Notes
*
* -   We assume that `searchValue.length < str.length`.
*
* @private
* @param {string} str - string to search
* @param {string} searchValue - string to match
* @returns {integer} index
*/
function lastIndexOf( str, searchValue ) {
	var len;
	var N;
	var i;

	len = str.length;
	N = searchValue.length;
	for ( i = len-N; i >= 0; i-- ) {
		if ( str.substring( i, i+N ) === searchValue ) {
			return i;
		}
	}
	return -1;
}


// MAIN //

/**
* Returns a serialized lunr.js search index.
*
* @private
* @param {(EmptyArray|ObjectArray)} files - list of files and their associated contents
* @returns {Object} serialized search index
*/
function createIndex( files ) {
	var idx = lunr( initialize );
	return idx.toJSON();

	/**
	* Initializes a search index.
	*
	* @private
	*/
	function initialize() {
		/* eslint-disable no-invalid-this */
		var title;
		var file;
		var blob;
		var desc;
		var id;
		var i;
		var j;

		this.field( 'title', {
			'boost': 10
		});
		this.field( 'description', {
			'boost': 5
		});
		this.field( 'introduction', {
			'boost': 3
		});
		this.ref( 'id' );

		// Add documents to search index:
		for ( i = 0; i < files.length; i++ ) {
			debug( 'Indexing file: %s', files[ i ].file );
			file = files[ i ].data;

			title = lowercase( file.match( RE_TITLE )[ 1 ] );
			debug( 'Title: %s', title );

			desc = file.match( RE_DESC )[ 1 ];
			desc = replace( desc, RE_LINKS, '$1' );
			desc = lowercase( desc );
			desc = replace( desc, RE_TRAILING_PERIOD, '' );
			debug( 'Description: %s', desc );

			id = dirname( files[ i ].file );
			j = lastIndexOf( id, '@' );
			id = id.substring( j );
			debug( 'id: %s', id );

			blob = {
				'title': title,
				'description': desc,
				'introduction': sectionText( file, 'intro' ),
				'id': id
			};
			debug( 'File data: %s', JSON.stringify( blob ) );
			this.add( blob );
		}
	}
}


// EXPORTS //

module.exports = createIndex;
