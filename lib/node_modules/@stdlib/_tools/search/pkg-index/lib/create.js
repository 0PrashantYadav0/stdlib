/**
* @license Apache-2.0
*
* Copyright (c) 2018 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

'use strict';

// MODULES //

var logger = require( 'debug' );
var lunr = require( 'lunr' );
var sectionText = require( './section_text.js' );


// VARIABLES //

var debug = logger( 'seach:pkg-index:create' );
var TITLE_REGEXP = /#[ ]*([^\n]+)\r?\n/;
var DESCR_REGEXP = />[ ]*([^\n]+)\r?\n/;


// MAIN //

/**
* Returns a serialized lunr.js search index.
*
* @private
* @param {(EmptyArray|StringArray)} files - list of files and their associated contents
* @returns {Object} serialized search index
*/
function createIndex( files ) {
	var idx = lunr( initialize );
	return idx.toJSON();

	/**
	* Initializes a search index.
	*
	* @private
	*/
	function initialize() {
		/* eslint-disable no-invalid-this */
		var file;
		var blob;
		var i;

		this.field( 'title', {
			'boost': 10
		});
		this.field( 'description', {
			'boost': 5
		});
		this.field( 'intro', {
			'boost': 3
		});
		this.field( 'usage', {
			'boost': 3
		});
		this.field( 'notes', {
			'boost': 2
		} );
		this.field( 'cli', {
			'boost': 1
		});
		this.field( 'references', {
			'boost': 1
		});
		this.ref( 'id' );

		// Add documents to search index:
		for ( i = 0; i < files.length; i++ ) {
			debug( 'Indexing file: %s', files[ i ].file );
			file = files[ i ].data;
			blob = {
				'title': file.match( TITLE_REGEXP )[ 1 ],
				'description': file.match( DESCR_REGEXP )[ 1 ],
				'intro': sectionText( file, 'intro' ),
				'usage': sectionText( file, 'usage' ),
				'notes': sectionText( file, 'notes' ),
				'cli': sectionText( file, 'cli' ),
				'references': sectionText( file, 'references' ),
				'id': files[ i ].file
			};
			debug( 'File data: %s', JSON.stringify( blob ) );
			this.add( blob );
		}
	}
}


// EXPORTS //

module.exports = createIndex;
