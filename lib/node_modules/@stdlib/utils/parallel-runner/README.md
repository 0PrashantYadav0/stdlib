# Parallel Runner

> Execute scripts in parallel.


<!-- <usage> -->

## Usage

``` javascript
var runner = require( '@stdlib/utils/parallel-runner' );
```

#### runner( files, [options,] clbk )

Executes scripts in parallel.

``` javascript
var files = [
    './a.js',
    './b.js'
];

function done( error ) {
    if ( error ) {
        throw error;
    }
    console.log( 'Done!' );
}

runner( files, done );
```

The function accepts the following `options`:

* __cmd__: executable file/command. Default: `'node'`.
* __workers__: number of workers. Default: number of CPUs minus `1`.
* __concurrency__: number of scripts to execute concurrently. Default: `options.workers`.
* __ordered__: `boolean` indicating whether to preserve the order of script output. Default: `false`.
* __maxBuffer__: maximum child process `stdio` buffer size. This option is __only__ applied when `options.ordered = true`. Default: `200*1024*1024` bytes.
* __uid__: child process user identity.
* __gid__: child process group identity.

By default, the number of workers running scripts is equal to the number of CPUs minus `1`, where one CPU is considered reserved for the master process. To adjust the number of workers, set the `workers` option.

``` javascript
var opts = {
    'workers': 8
};

runner( files, opts, done );
```

By default, the number of scripts running concurrently is equal to the number of workers. To adjust the concurrency, set the `concurrency` option.

``` javascript
var opts = {
    'concurrency': 6
};

runner( files, opts, done );
```

By specifying a concurrency greater than the number of workers, a worker may be executing more than `1` script at any one time. While not likely to be advantageous for synchronous scripts, setting a higher concurrency may be advantageous for scripts performing asynchronous tasks.

By default, each script is executed as a [Node.js][node-js] script.

``` text
$ node <script_path>
```

To run scripts via an alternative executable or none at all, set the `cmd` option.

``` javascript
var opts = {
    'cmd': '' // e.g., if scripts contain a shebang header
};

runner( files, opts, done );
```

By default, the `stdio` output for each script is interleaved; i.e., the `stdio` output from one script __may__ be interleaved with the `stdio` output from one or more other scripts. To preserve the `stdio` output for each script, set the `ordered` option.

``` javascript
var opts {
    'ordered': true
};

runner( files, opts, done );
```


<!-- </usage> -->


<!-- <notes> -->

## Notes

* Relative file paths are resolved relative to the current working directory.
* Ordered script output does __not__ imply that scripts are executed in order. To preserve script order, execute the scripts sequentially via some other means.
* Script concurrency cannot exceed the number of scripts.
* If the script concurrency is less than the number of workers, the number of workers is reduced to match the specified concurrency.

<!-- </notes> -->


<!-- <examples> -->

## Examples

``` javascript
var fs = require( 'fs' );
var path = require( 'path' );
var runner = require( '@stdlib/utils/parallel-runner' );

var nFiles = 100;
var files;
var opts;
var dir;

function template( id ) {
    var file = '';

    file += '\'use strict\';';

    file += 'var id;';
    file += 'var N;';
    file += 'var i;';

    file += 'id = '+id+';';
    file += 'N = 1e5;';
    file += 'console.log( \'File: %s. id: %s. N: %d.\', __filename, id, N );';

    file += 'for ( i = 0; i < N; i++ ) {';
    file += 'console.log( \'id: %s. v: %d.\', id, i );';
    file += '}';

    return file;
}

function createDir() {
    var dir = path.join( __dirname, 'fixtures' );
    fs.mkdirSync( dir );
    return dir;
}

function createScripts( dir, nFiles ) {
    var content;
    var fpath;
    var files;
    var i;

    files = new Array( nFiles );
    for ( i = 0; i < nFiles; i++ ) {
        content = template( i.toString() );
        fpath = path.join( dir, i+'.js' );
        fs.writeFileSync( fpath, content, {
            'encoding': 'utf8'
        });
        files[ i ] = fpath;
    }
    return files;
}

function cleanup() {
    var i;

    // Delete the temporary files...
    for ( i = 0; i < files.length; i++ ) {
        fs.unlinkSync( files[ i ] );
    }
    // Remove temporary directory:
    fs.rmdirSync( dir );
}

function done( error ) {
    if ( error ) {
        throw error;
    }
    cleanup();
    console.log( 'Done!' );
}

// Make a temporary directory to store files...
dir = createDir();

// Create temporary files...
files = createScripts( dir, nFiles );

// Set the runner options:
opts = {
    'concurrency': 3,
    'workers': 3,
    'ordered': false
};

// Run all temporary scripts:
runner( files, opts, done );
```

<!-- </examples> -->


<!-- <cli> -->

---

## CLI

<!-- <usage> -->

### Usage

``` bash
Usage: parallel-runner [options] <script1> <script2> ...

Options:

  -h,    --help                Print this message.
  -V,    --version             Print the package version.
         --cmd cmd             Executable file/command.
         --workers num         Number of workers.
         --concurrency num     Number of scripts to run concurrently.
         --ordered             Preserve order of script output.
         --uid uid             Process user identity.
         --gid gid             Process group identity.
         --maxbuffer size      Max buffer size for stdout and stderr.
```

<!-- </usage> -->

<!-- <examples> -->

### Examples

``` bash
$ parallel-runner --cmd 'node' --workers 4 --concurrency 8 ./foo.js ./bar.js
```

<!-- </examples> -->

<!-- </cli> -->



<!-- <links> -->

[node-js]: http://nodejs.org/

<!-- </links> -->
