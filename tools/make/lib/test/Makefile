
# VARIABLES #

TEST_RUNNER ?= tape

# Define the path to the `tap-spec` executable:
TAP_REPORTER ?= $(BIN)/tap-spec

# Define the path to the `tap-summary` executable:
TAP_SUMMARY ?= $(BIN)/tap-summary


# DEPENDENCIES #

# Test runner.
#
# All test runners are expected to output TAP.
ifeq ($(TEST_RUNNER), tape)
	include $(TOOLS_MAKE_DIR)/lib/test/tape.mk
endif


# TARGETS #

# Run unit tests.
#
# This target runs unit tests using a specified test runner and pipes TAP output to a reporter which is expected to be [tap-spec][1].
#
# To install tap-spec:
#     $ npm install tap-spec
#
# [1]: https://github.com/scottcorgan/tap-spec

test: test-local

test-local: node_modules
	NODE_ENV=$(NODE_ENV) \
	NODE_PATH=$(NODE_PATH_TEST) \
	$(TEST_RUNNER_BIN) \
		$(TEST_RUNNER_FLAGS) \
		$(TESTS) \
	| $(TAP_REPORTER)


# Generate a test summary.
#
# This target runs unit tests and aggregates TAP output as a test summary. The test summary is expected to be generated by [tap-summary][1].
#
# To install tap-summary:
#      $ npm install tap-summary
#
# [1]: https://github.com/zoubin/tap-summary

test-summary: node_modules
	NODE_ENV=$(NODE_ENV) \
	NODE_PATH=$(NODE_PATH_TEST) \
	$(TEST_RUNNER_BIN) \
		$(TEST_RUNNER_FLAGS) \
		$(TESTS) \
	| $(TAP_SUMMARY)


.PHONY: test test-local test-summary
